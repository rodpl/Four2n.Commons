<?xml version="1.0" encoding="utf-8"?>
<!--
    ==================================================
        Common targets library used by other files
    ==================================================
-->
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" ToolsVersion="3.5">
    <PropertyGroup>
        <CommonTargetsLoaded>true</CommonTargetsLoaded>
    </PropertyGroup>

    <!-- Import 3rd party targets -->
    <Import Project="$(MSBuildExtensionsPath)\MSBuildCommunityTasks\MSBuild.Community.Tasks.Targets" Condition="$(MSBuildCommunityTasksLib) == ''"/>
    <Import Project="$(MSBuildExtensionsPath)\rod.Commons\rod.Commons.Targets" Condition="$(RodCommonsTargetsIsLoaded) == ''" />

    <Target Name="Test" DependsOnTargets="Build;GetTestAssemblies" >
        <CallTarget Targets="InternalNUnit" />
    </Target>

    <Target Name="GetTestAssemblies" DependsOnTargets="Build">
        <ItemGroup>
            <Assemblies Include="$(TargetDir)$(TargetName)*.dll" />
        </ItemGroup>

        <RegexMatch Input="@(Assemblies)" Expression="$(TestDetectionExpression)[\.]dll$">
            <Output TaskParameter="Output" ItemName="TestAssemblies"/>
        </RegexMatch>
    </Target>

    <!--
        Internal tasks
    -->
    <Target Name="InternalNUnit" DependsOnTargets="_CreateTestResutsFolder" Condition=" '@(TestAssemblies)' != '' ">
        <PropertyGroup>
            <NUnitTestResultXmlFiles>$(TestResultsPath)\nunit-results.xml</NUnitTestResultXmlFiles>
            <NUnitTestResultTxtFiles>$(TestResultsPath)\nunit-results.txt</NUnitTestResultTxtFiles>
            <NUnitTestOutputFiles>$(TestResultsPath)\nunit-output.txt</NUnitTestOutputFiles>
            <NUnitTestSummaryFiles>$(TestResultsPath)\nunit-summary.txt</NUnitTestSummaryFiles>
        </PropertyGroup>

        <Exec Command="$(NUnitPath)\nunit-console.exe @(TestAssemblies, ' ') /xml=$(NUnitTestResultXmlFiles) /output=$(NUnitTestOutputFiles) /nologo" ContinueOnError="true">
            <Output TaskParameter="ExitCode" PropertyName="NUnitExitCode"/>
        </Exec>
        <Xslt
            Inputs="$(NUnitTestResultXmlFiles)"
            Xsl="$(NUnitPath)\xslt\Summary.xslt"
            Output="$(NUnitTestResultTxtFiles)" ContinueOnError="false"/>

        <ReadLinesFromFile File="$(NUnitTestResultTxtFiles)">
            <Output TaskParameter="Lines" ItemName="NUnitSummaryLines"/>
        </ReadLinesFromFile>

        <Merge Mode="TextLine"
               SourceFiles="$(NUnitTestResultTxtFiles);$(NUnitTestOutputFiles)"
               DestinationFile="$(NUnitTestSummaryFiles)" />

        <Message Condition="$(NUnitExitCode) == '0'" Text="@(NUnitSummaryLines, '$(NEW_LINE)')" />
        <Message Condition="$(NUnitExitCode) != '0'" Text="@(NUnitSummaryLines, '$(NEW_LINE)')" Importance="High" />
        <Exec Command="notepad.exe $(NUnitTestSummaryFiles)" />
        <Error Condition="$(NUnitExitCode) != '0'" Text="Some tests has $(NUnitExitCode) failed tests." />
    </Target>

    <Target Name="_CreateTestResutsFolder" Condition="$(TestResultsPath) != '' And !Exists('$(TestResultsPath)')">
        <MakeDir Directories="$(TestResultsPath)"/>
    </Target>
</Project>
